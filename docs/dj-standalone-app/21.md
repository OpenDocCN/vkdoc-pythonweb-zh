# 21.（使）自动化

在前一章中，我们通过测试不同版本的 Python 和 Django，以及替代的测试运行程序，扩展了测试独立应用程序的能力。您了解了如何使用 tox 或 nox 来测试不同的版本，以及如何测试您的迁移，并简要介绍了 pytest 测试框架。

在这一章中，我们将看看如何通过尽可能自动化来超越这一点，这不仅是为了我们的方便，也是为了帮助提高我们的应用程序的质量和其他贡献开发者的共享体验。

## 这是什么，为什么这么麻烦？

有许多方法可以定义自动化，但是为了我们的目的，我们将从这个定义开始:*它是任何不需要后续干预而对其他过程进行排序的过程。*我们在这里强调某种父流程是因为*某事*或*某人*仍然需要启动该流程，此外，自动化不是只有机器人或某种基于云的系统才能满足的事情。毕竟，测试自动化可以通过在您自己的计算机上运行命令来执行。使它自动化的是，整个测试套件可以只通过一个命令来运行。

因此，如果“自动化”听起来令人生畏，那么从替换“脚本”开始，你将获得 80%的好处。

开始自动化的第一个原因是，你可能不得不再次做这些事情，并且你想确保你每次都以完全相同的方式做它们。你不想忘记一步；你不会想在键盘前等待开始下一步。

不太明显的是，它节省了考虑自动化任务的时间和精力。你可能想要某个特定的结果，甚至知道做 X 会得到 Y，如果跳过 X 很容易，你可能会这样做。就像保持健康一样，你最好的办法是提前做出可执行的决定。自动化不仅可以确保更好的结果，还可以减少实现这些结果所需的精神周期。

自动化开发过程也使得让其他人参与进来变得更加容易。当测试他们的代码和创建拉请求时，你应该简单地希望每个人都遵循相同的步骤吗？你会让他们按照文档中的步骤，像代码猴子一样复制粘贴吗？当然不是！你可以给他们一个脚本，自动执行他们需要遵循的所有步骤，来完成你所做的事情。比这更好的是，如果你建立一个独立的服务，你甚至不需要依靠贡献者自己来运行这些任务。这节省了入职时间、调试时间和压力。

## 开始自动化

有许多不同的*事情*你可以开始自动化，包括测试、相关代码检查、发布过程，还有不同的*地方*你可以开始自动化，例如，本地或使用远程过程。如果没有紧急的和特定的需求，您应该开始自动化(I)会阻碍发布甚至进一步部署的关键任务，如测试，(ii)与开发相关的任务，使其他开发人员更容易参与，以及(iii)与发布相关的后续任务，使生活更容易，并可以减少短期的总线因素。

测试是自动化最简单的，因为您已经有了可以运行的测试。一旦你有了可用和有用的测试，让它们自动运行是很有帮助的，例如，每次你把代码推送到你的存储库的时候。这确保了测试总是运行的，无论您是否记得在本地运行它们。如果你是独立工作的话，这是一点额外的好处，但是这种好处会随着每一个额外的开发人员而增加。您不再需要担心其他人是否在推送他们的代码或提交 pull 请求之前运行了测试，您可以自己看到结果。

## 持续集成服务

大多数自动化的基础是持续集成服务。这是一项服务——无论是像 Jenkins 这样的自我管理流程还是第三方 tasks 都会为您的项目运行指定的任务。这些通常包括运行测试套件和报告结果，以及部署更新，并且可以运行以响应代码库的更新或由一些其他动作触发。

在这里，我们将介绍一些更受欢迎的第三方服务，以及一个独立应用程序的基本配置，该应用程序只需要 Django，并使用一个 runtests.py 文件来启动测试。这些可以作为开始，但更重要的是，它们的共性在高层次上描述了这些服务如何工作。

### 特拉维斯 CI

Travis CI 是持续集成即服务的鼻祖，至少对于开源软件来说是这样。使用该服务需要一个名为. travis.yml 的配置文件，该文件位于项目的根目录下，并通过 Travis web 应用程序在 GitHub 上跟踪您的项目。Travis 服务只支持基于 GitHub 的项目。

一个简单的测试设置非常简单:

```
os: linux
dist: bionic
language: python
python:
  - "3.8"

install:
  - pip install django==3.0
script:
  - python runtests.py

```

除此之外，Travis 提供了对版本矩阵化的良好支持(类似于 tox)，本机支持对多个版本的 Python 并发运行测试。

### 开源代码库

GitHub 一直是用 Git 托管开源软件项目的最受欢迎的选择。最近，GitHub 增加了“动作”功能，允许在每个项目的基础上运行各种工作流。这些是与单个 YAML 文件一起添加到。github/wor flow/你的项目目录。

实现与 Travis 示例相同的测试运行的示例如下:

```
name: Blog
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Set up Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          pip install Django==3.0

      - name: Run the tests
        run: |
          python runtests.py

```

这里的 GitHub Actions 测试作业配置比 Travis 配置更详细，这在很大程度上是因为 GitHub Actions 本身并不是一个持续集成，而是一个通用的工作流构建工具，您可以在这个工具上构建自己所需的持续集成任务。这使它更加灵活，但也有点复杂。对大多数人来说，使用 GitHub Actions 的主要好处是，对于已经用 GitHub 托管的项目，它无需任何进一步的集成就可以立即使用。

### GitLab

GitLab 是另一种 Git 托管服务，是 GitHub 的替代产品，它将 CI 产品直接集成到 web 应用程序和可安装的自托管版本中，后者是开源的:

```
image: "python:3.8"

before_script:
  - pip install django==3.0

stages:
  - Test

test:
  stage: Test
  script:
  - python runtests.py

```

GitLab 的 CI 服务是专门构建的，因此基本配置很简单。但是，它是高度可定制的，并且与其他 CI 即服务产品不同，它是开源的，可以自我管理。

### 绕圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈圈

CircleCI 的业务是持续集成，像 Travis 一样，他们为开源项目提供各种免费和付费计划。测试工作流的一个简单示例如下:

```
version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.8.0

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install django==3.0

      - run:
          name: run tests
          command: |
            . venv/bin/activate
            python runtests.py

```

### 其他人

这并不是你可以用来自动化测试你的独立应用的服务或软件的详尽列表。

## 摘要

在本章中，您已经学习了如何利用自动化系统来简化代码测试，在不同的环境中进行测试，以及为您的应用程序提供权威的测试 oracle。这些步骤中的每一步都有助于减少原作者和后续贡献者在开发过程中的摩擦。在接下来的章节中，我们将探讨何时在你的应用中使用特定于数据库的功能，以及如何鼓励其他开发者在你的独立应用中进行协作。