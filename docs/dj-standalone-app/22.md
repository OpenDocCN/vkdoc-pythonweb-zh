# 22.数据库和其他特定于后端的考虑事项

使用像 Django 这样的框架的好处之一是，它为不同的*后端服务*提供抽象接口，范围从数据库到电子邮件和缓存。一个典型的已部署的 Django 项目只需要支持一个或两个给定的数据库或后端，这有助于在单个项目中使用特定于后端的特性。这些功能可能会提供额外的功能或性能优势，但在发布的独立应用程序中，应用程序的使用将仅限于特定的数据库或后端。

在这一章中，我们将简单但独立地回顾关于在你的应用中使用特定数据库选择的问题，包括何时包含特定于后端的特性，以及当你这样做时如何处理它们。

## 特定于后端的实现和功能

使用像 Django 这样的 ORM 的好处之一是它是数据库不可知的。相同的应用程序代码可以使用 PostgreSQL、MySQL 甚至 SQLite 运行。然而，有时使用特定于数据库的功能似乎或者确实是有利的。除了共性之外，每个数据库的工作方式不同，提供的功能略有不同，并且有不同的优点和缺点。如果您知道您的项目将使用什么数据库，充分利用这些细节是有意义的。

我们应该注意，这个问题的总体假设是，你的独立应用面向更广泛的受众。如果你的独立应用程序只是在一个使用通用技术栈的大型组织内部使用，这就没那么重要了。

特定于数据库的代码的最直接的例子是原始 SQL。抛开在已部署的项目中发布原始 SQL 是否是个好主意不谈，使用直接 SQL 的典型好处是，您可以直接依赖数据库特性，包括数据库函数，这些都没有在 ORM 中公开。您通常还可以一次性编写更具表达性的查询。

然而，ORM 是数据库不可知的；甚至 Django 也附带了特定于数据库的特性！contrib.postgres 应用程序包括 PostgreSQL 特定的数据库函数、RangeField 和 ArrayField 等字段、索引和其他数据库不提供的全文搜索功能(在 Django 中)。

## 探讨特定于数据库的功能

根据经验，除非你的应用特别关注某种数据库或后端特定的功能，否则除非绝对需要，否则尽量避免依赖这些数据库或后端特定的功能。

依赖特定于后端的功能的一个明显的候选是地理空间功能。GeoDjango，即 contrib.gis，支持多个数据库后端；但是，只有 PostgreSQL 的 PostGIS 完全支持该功能。模型字段可以跨支持的数据库后端使用；然而，不同的地理空间数据库后端对许多查找和功能的支持并不一致。如果实际上使用其中的一个有重要的价值，比如地理空间聚合或边界框重叠，那么这是后端特定(或后端限制)功能的合理使用。

当然，也有解决方法，包括特定于数据库的功能，而不限制开发人员用户的使用范围。一种是包含该功能，但不将其直接集成到其他一些关键功能中，例如，添加一个依赖于特定于后端的功能的查询方法，但不在提供的视图或管理类中使用它。对开发人员用户的另一个好处是，如果他们的数据库后端不支持给定的特性，或者不知道它是否支持(任何定制的后端类都可能使您的代码看不清这一点)，那么可以包含警告。

```py
import warnings
from django.conf import settings

if (
        'django.contrib.gis.db.backends.postgis' not in
        [db['ENGINE'] for db in settings.DATABASES.values()]
):
        warnings.warn("""PostGIS not found, not all App features
                        may be supported.""")

```

一种在某些情况下会起作用的更大胆的方法是完全退出特定于后端的功能。有两种方法可以做到这一点:(I)使用更简单的实现，(ii)允许开发人员用户集成他们自己的类(使用控制反转)。第一种策略将在有限的情况下工作，一个经过验证的地理空间示例是存储地理空间数据，如坐标甚至多边形。如果您的应用程序没有使用这些数据进行查找或地理空间查询，并且没有提供这样做的清晰用例，那么非地理空间字段就足够了。可以使用 DecimalField 将坐标存储在一对字段中，并使用属性进行访问。

```py
class Place(models.Model):
        latitude = models.DecimalField(...)
        longitude = models.DecimalField(...)

        @property
        def coords(self):
                return self.latitude, self.longitude

        @coords.setter
        def coords(self, lat, lng):
                self.latitude, self.longitude = lat, lng

```

多边形有点困难，但同样，如果数据只存储或表示在另一层，例如，通过 API 提供给前端应用程序进行渲染，那么它的存储要求就不那么具体了。ArrayField 可能就足够了(尽管也受 PostgreSQL 的限制)，或者 JSONField 也可以(现在 Django 3 中 MySQL 支持)。

需要某种特定于后端的特性的另一种方法是允许某个组件类被注册或用作初始化参数，该初始化参数符合基线接口，但可以完全由最终用户控制。Django 的数据库后端的工作方式符合这一要求，其他项目如 Haystack 的类似功能也符合这一要求。在这两种情况下，您都可以使用 Django 设置向库提供指向后端类或模块的虚线路径，库将加载并使用该特定的类或模块。这意味着后端是无限可定制的(或几乎如此)，允许用户在不同的搜索引擎之间切换，也可以创建适合他们特定需求的修改版本，无论这些需求是小功能还是与一个新的完全不同的支持服务合作。

## 摘要

在这一章中，你已经了解了各种类型的*后端特定的*选项，以及如何判断使用它们对于你的独立应用来说是否是一个好的策略。